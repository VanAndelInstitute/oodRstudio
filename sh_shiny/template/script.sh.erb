#!/usr/bin/env bash

#
# Load modules
#

# Purge the module environment to avoid conflicts
#module reset



# Load the requested R module (required)
module load <%= context.sh_r_version %>

<%- unless context.sh_modules.blank? -%>
# Load additional modules (optional)
module load <%= context.sh_modules %>
<%- end -%>


#
# Start shiny Server
#


#rstudio tmp dir



# Set working directory to home directory

# Launch the shiny 
shinyproject="<%= context.shiny_app_path %>"

echo "Starting up shiny..."
set -x
if [ -e "$shinyproject" ]; then
  if [ -d "$shinyproject" ]; then
    Rscript -e  "shiny::runApp('$shinyproject')" &
  else
    Rscript "$shinyproject" &
  fi
else
  echo "could not find valid shiny project, bad path?"
  exit 1
fi
sleep 10 
shinyport=`cat output.log |grep Listening | awk -F'[:/ ]+' '{print $5}'`
if [ -n "$shinyport" ]; then
  if ! [[ "$shinyport" =~ ^[0-9]+$ ]] || [ "$shinyport" -lt 1 ] || [ "$shinyport" -gt 65535 ]; then
    echo "did not find shiny running on localhost tcp port"
  else 
    /varidata/research/software/caddy/default/caddy reverse-proxy --from http://:${port} --to localhost:$shinyport
  fi
fi
